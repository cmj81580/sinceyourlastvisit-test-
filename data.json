async function filterAttractions() {
  const dateInput = document.getElementById("visitDate").value;
  if (!dateInput) return;

  const visitDate = new Date(dateInput);
  const sheetURL = "https://docs.google.com/spreadsheets/d/1AifnMTd7E5G06-pAU4np2kO_IjXSe9xiAJGbJlW_exc/gviz/tq?tqx=out:csv";

  const response = await fetch(sheetURL);
  const csvText = await response.text();

  const rows = csvText.trim().split("\n").map(r => r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '')));
  const headers = rows[0];
  const entries = rows.slice(1).map(row => {
    const obj = {};
    headers.forEach((header, i) => obj[header.toLowerCase()] = row[i]);
    return obj;
  });

  const filtered = entries
    .filter(item => item.status?.toLowerCase() === "new")
    .filter(item => {
      const parts = item.date?.split("/");
      if (!parts || parts.length !== 3) return false;
      const itemDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
      return itemDate > visitDate;
    })
    .sort((a, b) => {
      const aDate = new Date(a.date.split("/").reverse().join("-"));
      const bDate = new Date(b.date.split("/").reverse().join("-"));
      return bDate - aDate;
    });

  const container = document.getElementById("attractionList");
  container.innerHTML = "";

  if (filtered.length === 0) {
    container.innerHTML = "<p>No new attractions since your last visit!</p>";
    return;
  }

  filtered.forEach(item => {
    const card = document.createElement("div");
    card.className = "attraction-card";

    card.innerHTML = `
      <img src="${item.image}" alt="${item.title}" />
      <div class="info">
        <h3>${item.title}</h3>
        <p><strong>Opened:</strong> ${item.date}</p>
        <p><strong>Type:</strong> ${item.type || "N/A"}</p>
        <p><strong>Area:</strong> ${item.area || "N/A"}</p>
        <p>${item.description}</p>
        ${item.notes ? `<p><em>Note:</em> ${item.notes}</p>` : ""}
        ${item.source ? `<p><a href="${item.source}" target="_blank">More info</a></p>` : ""}
      </div>
    `;

    container.appendChild(card);
  });
}
